<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì¬ë£Œ ì •ë³´</title>
    <link href="/bootswatch/brite/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* ì»¤ìŠ¤í…€ ëª¨ë‹¬ ë°°ê²½/ìœ„ì¹˜ CSSëŠ” ë” ì´ìƒ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. */
    </style>
</head>
<body>


<div class="container">
    <div>
        <div class="row">
            <div class="col-lg-12">
                <div class="page-header">
                    <h1 id="tables">ì¬ë£Œ ê´€ë¦¬</h1>
                </div>
                <p>
                    <button type="button" id="showAddModalButton" class="btn btn-primary">add</button>
                </p>
                <div>
                    <nav class="navbar navbar-expand-lg bg-primary" data-bs-theme="light">
                        <div class="container-fluid">
                            <a class="navbar-brand" href="#">Navbar</a>
                            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
                                <span class="navbar-toggler-icon"></span>
                            </button>

                            <div class="collapse navbar-collapse" id="navbarColor01">
                                <ul class="navbar-nav me-auto">
                                    <li class="nav-item">
                                        <a class="nav-link active" href="#">Home
                                            <span class="visually-hidden">(current)</span>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#">Features</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#">Pricing</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#">About</a>
                                    </li>
                                    <li class="nav-item dropdown">
                                        <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Dropdown</a>
                                        <div class="dropdown-menu">
                                            <a class="dropdown-item" href="#">Action</a>
                                            <a class="dropdown-item" href="#">Another action</a>
                                            <a class="dropdown-item" href="#">Something else here</a>
                                            <div class="dropdown-divider"></div>
                                            <a class="dropdown-item" href="#">Separated link</a>
                                        </div>
                                    </li>
                                    <li class="nav-item dropdown">
                                        <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false" id="pageSize">10</a>
                                        <div class="dropdown-menu">
                                            <a class="dropdown-item" href="javascript:void(0);" onclick="$.setPageSize(5);">5</a>
                                            <a class="dropdown-item" href="javascript:void(0);" onclick="$.setPageSize(10);">10</a>
                                            <a class="dropdown-item" href="javascript:void(0);" onclick="$.setPageSize(20);">20</a>
                                            <a class="dropdown-item" href="javascript:void(0);" onclick="$.setPageSize(30);">30</a>
                                            <div class="dropdown-divider"></div>
                                            <a class="dropdown-item" href="#">Separated link</a>
                                        </div>
                                    </li>
                                </ul>
                                <form class="d-flex" id="searchForm">
                                    <input id="searchText" class="form-control me-sm-2" type="search" placeholder="ê²€ìƒ‰">
                                    <button id="searchButton" class="btn btn-secondary my-2 my-sm-0" type="submit">Search</button>
                                </form>
                            </div>
                        </div>
                    </nav>
                </div>
                <div>
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th scope="col">ID<span id="id_desc" class="sortButton sortDesc">â–¼</span><span id="id_asc" class="sortButton sortAsc">â–³</span></th>
                            <th scope="col">Name<span id="name_desc" class="sortButton sortDesc">â–½</span><span id="name_asc" class="sortButton sortAsc">â–³</span></th>
                            <th scope="col">ingredientCategoryEntity.name<span id="ingredientCategoryEntity.name_desc" class="sortButton sortDesc">â–½</span><span id="ingredientCategoryEntity.name_asc" class="sortButton sortAsc">â–³</span></th>
                        </tr>
                        </thead>
                        <tbody id="listBody">
                        <tr>
                            <th scope="row">Default</th>
                            <td>Column content</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <ul class="pagination" id="paginationUL"></ul>
    </div>

    <div class="modal fade" id="addEditModal" tabindex="-1" aria-labelledby="addEditModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div id="modalDialog" class="modal-content">
                <div class="modal-header">
                    <h5 id="modal_title" class="modal-title"></h5>
                    <button type="button" class="btn-close modalCloseButton" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div>
                        <div>
                            <label class="col-form-label mt-4" for="id">id</label>
                            <input type="text" class="form-control" placeholder="id" id="id" disabled="">
                        </div>
                        <div>
                            <label class="col-form-label mt-4" for="name">ê´€ë¦¬</label>
                            <input type="text" class="form-control" placeholder="ì¬ë£Œ ê´€ë¦¬" id="name" maxlength="40">
                        </div>
                        <div>
                            <label class="col-form-label mt-4" for="ingredientCategoryId">ì¹´í…Œê³ ë¦¬</label>
                            <select class="form-select" id="ingredientCategoryId">
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="saveButton" class="btn btn-primary">ì €ì¥</button>
                    <button type="button" id="deleteButton" class="btn btn-primary">ì‚­ì œ</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/bootswatch/brite/js/bootstrap.bundle.min.js"></script>
<script src="/bootswatch/brite/js/prism.js" data-manual></script>
<script src="/bootswatch/brite/js/custom.js"></script>
<script src="/js/jquery-3.7.1.min.js"></script>

<script>
    let modalMode = 1;
    let sortString = "id,desc";
    let curPage = 1;

    (function ($) {
        $.setPageSize = (num) => {
            $("#pageSize").text(num);
            $.loadData($.getPagable());
        };

        $.getPagable = () => {
            return {
                "name": $("#searchText").val(),
                "page": curPage - 1,
                "size": $("#pageSize").text(),
                "sort": sortString,
            };
        };

        $.loadData = (pagable) => {
            let url = `/api/v1/ingredient/search?name=${pagable.name}&page=${pagable.page}&size=${pagable.size}&sort=${pagable.sort}`;
            $.ajax({
                url: url,
                method: 'GET'
            }).done(function(data, textStatus, jqXHR) {
                console.log("Success:", data.result);
                $.printList(data.result);
            }).fail(function(jqXHR, textStatus, errorThrown) {
                console.log("Error:", textStatus, errorThrown);
                alert(`${jqXHR.responseJSON.code} : ${jqXHR.responseJSON.message}`);
            });
        };

        $.printList = function(result) {
            $.makeDataRows(result.content);
            $.makePageButtons(result);
        };

        $.makeOneRow = function(item) {
            return `<tr onclick="$.showInfo(${item.id})">
                        <th scope="row">${item.id}</th>
                        <td>${item.name}</td>
                        <td>${item.ingredientCategoryEntity.name}</td>
                    </tr>`;
        };

        $.makeDataRows = function(list) {
            let html = list.map(item => $.makeOneRow(item)).join('');
            $("#listBody").empty().append(html);
        };

        $.makePageButtons = function(result) {
            let html = "";
            let curPageNum = result.pageable.pageNumber + 1;
            let totalPages = result.totalPages;

            html += $.makePrevButton(curPageNum);
            html += $.makeFSTFFButtons(curPageNum, totalPages);
            html += $.makeNextButton(curPageNum, totalPages);
            $("#paginationUL").empty().append(html);
        };

        $.makePrevButton = function(curPage) {
            if (curPage <= 1) {
                return `<li class="page-item disabled">
                            <a class="page-link" href="#" id="pagePrev">Â«</a>
                        </li>`;
            } else {
                return `<li class="page-item">
                            <a class="page-link" href="javascript:$.goPage(${curPage - 1});" id="pagePrev">Â«</a>
                        </li>`;
            }
        };

        $.makeFSTFFButtons = function(curPage, maxPage) {
            let startPage = Math.max(1, curPage - 2);
            let endPage = Math.min(maxPage, startPage + 4);
            if (endPage - startPage < 4 && maxPage > 4) {
                startPage = Math.max(1, endPage - 4);
            }
            let html = "";
            for (let page = startPage; page <= endPage; page++) {
                if (page === curPage) {
                    html += `<li class="page-item active">
                                <a class="page-link" href="javascript:$.goPage(${page});">${page}</a>
                            </li>`;
                } else {
                    html += `<li class="page-item">
                                <a class="page-link" href="javascript:$.goPage(${page});">${page}</a>
                            </li>`;
                }
            }
            return html;
        };

        $.makeNextButton = function(curPage, maxPage) {
            if (curPage >= maxPage) {
                return `<li class="page-item disabled">
                            <a class="page-link" href="#" id="pageNext">Â»</a>
                        </li>`;
            } else {
                return `<li class="page-item">
                            <a class="page-link" href="javascript:$.goPage(${curPage + 1});" id="pageNext">Â»</a>
                        </li>`;
            }
        };

        $.goPage = function(goPage) {
            curPage = goPage;
            $.loadData($.getPagable());
        };

        $.getSortButton = (tag) => {
            let str = $(tag).attr('id');
            let arr = str.split("_");
            let req = `${arr[0]},${arr[1]}`;

            $(".sortDesc").text("â–½");
            $(".sortAsc").text("â–³");
            if (arr[1] === "desc") {
                $("#" + str).text("â–¼");
            } else {
                $("#" + str).text("â–²");
            }

            sortString = req;
            $.loadData($.getPagable());
        };

        $.loadCategories = function() {
            $.ajax({
                url: '/api/v1/ingredient-category',
                method: 'GET'
            }).done(function(data) {
                console.log("Categories loaded:", data.result);
                $.populateCategoryDropdown(data.result.content);
            }).fail(function(jqXHR) {
                console.log("Error loading categories:", jqXHR);
            });
        };

        $.populateCategoryDropdown = function(categories) {
            let html = categories.map(category =>
                `<option value="${category.id}">${category.name}</option>`
            ).join('');
            $("#ingredientCategoryId").empty().append(html);
        };

        $.insert = function() {
            let dataMember = {
                "name": $("#name").val(),
                "ingredientCategoryId": $("#ingredientCategoryId").val()
            };

            $.ajax({
                url: '/api/v1/ingredient',
                type: "POST",
                data: JSON.stringify(dataMember),
                contentType: 'application/json',
            }).done(function(data) {
                console.log("Success:", data.result);
                $.clearModalForm();
                $.loadData($.getPagable());
                // Bootstrap ëª¨ë‹¬ì„ ë‹«ê¸°
                const modal = bootstrap.Modal.getInstance(document.getElementById('addEditModal'));
                modal.hide();
            }).fail(function(jqXHR) {
                console.log("Error:", jqXHR);
                alert(`${jqXHR.responseJSON.code} : ${jqXHR.responseJSON.message}`);
            });
        };

        $.clearModalForm = () => {
            $("#id").val("");
            $("#name").val("");
            $("#ingredientCategoryId").val("");
        };

        // ğŸŒŸğŸŒŸğŸŒŸ showModal í•¨ìˆ˜ ìˆ˜ì • ğŸŒŸğŸŒŸğŸŒŸ
        $.showModal = (mode) => {
            $.loadCategories(); // ëª¨ë‹¬ì„ ì—´ê¸° ì „ì— ì¹´í…Œê³ ë¦¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.

            const modalElement = document.getElementById('addEditModal');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();

            if (mode === 1) {
                $("#modal_title").text("ì…ë ¥ ì°½");
                $("#deleteButton").hide();
            } else if (mode === 2) {
                $("#modal_title").text("ë³´ê¸°/ìˆ˜ì • ì°½");
                $("#deleteButton").show();
            }
            modalMode = mode;
        };

        $.showInfo = function(id) {
            $.ajax({
                url: '/api/v1/ingredient/' + id,
                method: 'GET'
            }).done(function(data) {
                console.log("Success:", data.result);
                $.printOne(data.result);
            }).fail(function(jqXHR) {
                console.log("Error:", jqXHR);
                alert(`${jqXHR.responseJSON.code} : ${jqXHR.responseJSON.message}`);
            });
        };

        $.printOne = function(item) {
            if (item == null || item === undefined) {
                return;
            }
            $("#id").val(item.id);
            $("#name").val(item.name);
            $("#ingredientCategoryId").val(item.ingredientCategoryEntity.id);
            $.showModal(2);
        };

        $.update = function() {
            let dataMember = {
                "id": $("#id").val(),
                "name": $("#name").val(),
                "ingredientCategoryId": $("#ingredientCategoryId").val(),
            };

            $.ajax({
                url: '/api/v1/ingredient/' + $("#id").val(),
                type: "PATCH",
                data: JSON.stringify(dataMember),
                contentType: 'application/json',
            }).done(function(data) {
                console.log("Success:", data.result);
                $.clearModalForm();
                $.loadData($.getPagable());
                // Bootstrap ëª¨ë‹¬ì„ ë‹«ê¸°
                const modal = bootstrap.Modal.getInstance(document.getElementById('addEditModal'));
                modal.hide();
            }).fail(function(jqXHR) {
                console.log("Error:", jqXHR);
                alert(`${jqXHR.responseJSON.code} : ${jqXHR.responseJSON.message}`);
            });
        };

        $.delete = function() {
            if (!confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                return;
            }

            $.ajax({
                url: '/api/v1/ingredient/' + $("#id").val(),
                type: "DELETE",
            }).done(function(data) {
                console.log("Success:", data.result);
                $.clearModalForm();
                $.loadData($.getPagable());
                // Bootstrap ëª¨ë‹¬ì„ ë‹«ê¸°
                const modal = bootstrap.Modal.getInstance(document.getElementById('addEditModal'));
                modal.hide();
            }).fail(function(jqXHR) {
                console.log("Error:", jqXHR);
                alert(`${jqXHR.responseJSON.code} : ${jqXHR.responseJSON.message}`);
            });
        };
    })(jQuery);

    $(document).ready(function(){
        // ì´ˆê¸° ë°ì´í„° ë¡œë”©
        $.loadData($.getPagable());

        // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        $('#showAddModalButton').click(function() {
            $.clearModalForm();
            $.showModal(1);
        });

        // ğŸŒŸğŸŒŸğŸŒŸ ëª¨ë‹¬ ë‹«í˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ğŸŒŸğŸŒŸğŸŒŸ
        // 'ë‹«ê¸°' ë²„íŠ¼ í´ë¦­ ì‹œ í¼ì´ ì´ˆê¸°í™”ë˜ë„ë¡ í•©ë‹ˆë‹¤.
        // ê¸°ì¡´ì˜ `.modalCloseButton` í´ë¦­ ì´ë²¤íŠ¸ëŠ” ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.
        const addEditModal = document.getElementById('addEditModal');
        addEditModal.addEventListener('hidden.bs.modal', function () {
            $.clearModalForm();
        });

        $("#saveButton").click(function() {
            if (modalMode === 1) {
                $.insert();
            } else if (modalMode === 2) {
                $.update();
            }
        });

        $("#deleteButton").click(function() {
            $.delete();
        });

        $(".sortButton").click(function() {
            $.getSortButton(this);
        });

        $("#searchButton").click(function(event) {
            event.preventDefault(); // í¼ ì œì¶œ ë°©ì§€
            $.loadData($.getPagable());
        });
    });
</script>
</body>
</html>